<!DOCTYPE html>
<html lang="zh-TW" data-theme="corporate">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訂閱支出追蹤器</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="app.js"></script>
</head>
<body class="bg-base-200 min-h-screen">
  <div x-data="subscriptionManager">
    <!-- 固定頂部導航欄 -->
    <div class="navbar bg-base-100 shadow-lg fixed top-0 left-0 right-0 z-40">
      <div class="navbar-start">
        <h1 class="text-xl font-bold ml-4">訂閱管理系統</h1>
      </div>
      
      <div class="navbar-end">
        <!-- 已登入狀態 -->
        <div x-show="isLoggedIn" class="flex items-center space-x-4 mr-4">
          <div class="flex items-center space-x-2">
            <div class="avatar placeholder">
              <div class="bg-primary text-primary-content rounded-full w-8">
                <span class="text-xs" x-text="currentUser?.username?.charAt(0).toUpperCase()">U</span>
              </div>
            </div>
            <span class="text-sm" x-text="currentUser?.username">用戶</span>
          </div>
          <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-ghost btn-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </label>
            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-32">
              <li><a @click="logout()">登出</a></li>
            </ul>
          </div>
        </div>
        
        <!-- 未登入狀態 -->
        <div x-show="!isLoggedIn" class="flex items-center space-x-2 mr-4">
          <button @click="showLogin()" class="btn btn-ghost btn-sm">登入</button>
          <button @click="showRegister()" class="btn btn-primary btn-sm">註冊</button>
        </div>
      </div>
    </div>

    <!-- 主要內容區域 -->
    <div class="container mx-auto px-4 py-8 max-w-4xl mt-20">

    <!-- 月總支出顯示區域 -->
    <div class="hero bg-gradient-to-br from-primary/10 to-secondary/10 rounded-3xl mb-8 backdrop-blur-sm">
      <div class="hero-content text-center py-12">
        <div class="max-w-md">
          <h1 class="text-base-content/70 text-xl mb-4">這個月你在訂閱服務上花了</h1>
          <div class="text-7xl md:text-8xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-6" x-text="formatCurrency(monthlyTotal)">NT$0</div>
          <div class="space-y-3">
            <div class="stats shadow-lg bg-base-100/80 backdrop-blur-sm">
              <div class="stat">
                <div class="stat-title">年度預估支出</div>
                <div class="stat-value text-2xl text-error" x-text="formatCurrency(monthlyTotal * 12)">NT$0</div>
              </div>
            </div>
        
            <!-- 預算設定和狀態 -->
            <div x-show="monthlyBudget > 0" class="mt-6">
              <div class="card bg-base-100 shadow-xl backdrop-blur-sm border border-base-300/50">
                <div class="card-body p-6">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="card-title text-base">月度預算</h3>
                    <button @click="openBudgetSetting()" class="btn btn-ghost btn-sm">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                      調整
                    </button>
                  </div>
                  <div class="flex justify-between items-center mb-4">
                    <span class="text-2xl font-bold" x-text="formatCurrency(monthlyBudget)"></span>
                    <div class="badge badge-lg" :class="getBudgetStatus() === 'over' ? 'badge-error' : getBudgetStatus() === 'warning' ? 'badge-warning' : 'badge-success'" x-text="getBudgetStatusText()"></div>
                  </div>
                  <div class="mb-4">
                    <progress 
                      class="progress w-full h-3" 
                      :class="getBudgetStatus() === 'over' ? 'progress-error' : getBudgetStatus() === 'warning' ? 'progress-warning' : 'progress-success'"
                      :value="Math.min(getBudgetUsagePercentage(), 100)" 
                      max="100"
                    ></progress>
                  </div>
                  <div class="flex justify-between text-sm opacity-70">
                    <span x-text="`已使用 ${getBudgetUsagePercentage().toFixed(1)}%`"></span>
                    <span x-show="getBudgetStatus() !== 'over'" x-text="`剩餘 ${formatCurrency(getRemainingBudget())}`"></span>
                    <span x-show="getBudgetStatus() === 'over'" x-text="`超支 ${formatCurrency(monthlyTotal - monthlyBudget)}`" class="text-error"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <button 
              x-show="monthlyBudget <= 0" 
              @click="openBudgetSetting()"
              class="btn btn-outline btn-primary mt-6"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              設定月度預算
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 預算設定彈窗 -->
    <div class="modal" :class="showBudgetSetting ? 'modal-open' : ''" @click.self="closeBudgetSetting()">
      <div class="modal-box w-11/12 max-w-md">
        <h3 class="font-bold text-xl mb-6">設定月度預算</h3>
        <div class="form-control w-full mb-6">
          <label class="label">
            <span class="label-text">預算金額 (NT$)</span>
          </label>
          <input 
            type="number" 
            x-model="tempBudget"
            placeholder="3000"
            min="0"
            step="100"
            class="input input-bordered w-full focus:input-primary"
            @keydown.enter="saveBudget()"
          >
        </div>
        <div class="modal-action">
          <button 
            @click="saveBudget()"
            class="btn btn-primary"
            data-loading="saveBudget"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            儲存
          </button>
          <button 
            @click="closeBudgetSetting()"
            class="btn btn-ghost"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 即將到期提醒 -->
    <div x-show="getUpcomingExpiry().length > 0" class="alert alert-warning shadow-lg mb-8 backdrop-blur-sm">
      <div class="w-full">
        <div class="flex items-center mb-4">
          <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <h3 class="font-bold text-lg">即將到期提醒</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <template x-for="subscription in getUpcomingExpiry()" :key="subscription.id">
            <div class="card bg-base-100 shadow-sm">
              <div class="card-body p-4">
                <div class="flex flex-col gap-2">
                  <div class="flex items-center justify-between">
                    <h4 class="font-semibold truncate" x-text="subscription.name"></h4>
                    <div class="badge badge-sm" :class="getDaysUntilPayment(subscription) <= 3 ? 'badge-error' : 'badge-warning'" x-text="getExpiryWarningText(subscription)"></div>
                  </div>
                  <p class="text-sm opacity-70" x-text="formatCurrency(subscription.price)"></p>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- 新增/編輯訂閱表單 -->
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <!-- 未登入提示 -->
        <div x-show="!isLoggedIn" class="alert alert-info mb-6">
          <svg class="w-6 h-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="font-bold">需要登入才能管理訂閱</h3>
            <div class="text-sm">請先登入或註冊帳號，以便將訂閱資料保存到雲端。</div>
            <div class="mt-2">
              <button @click="showLogin()" class="btn btn-sm btn-outline mr-2">登入</button>
              <button @click="showRegister()" class="btn btn-sm btn-primary">註冊</button>
            </div>
          </div>
        </div>

        <div class="flex justify-between items-center mb-6">
          <h2 class="card-title text-2xl" x-text="isEditing ? '編輯訂閱服務' : '新增訂閱服務'">新增訂閱服務</h2>
          <button 
            x-show="isEditing" 
            @click="cancelEdit()"
            class="btn btn-ghost btn-sm"
          >
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            取消編輯
          </button>
        </div>
        <form @submit.prevent="isEditing ? updateSubscription() : addSubscription()" class="space-y-6" :class="!isLoggedIn ? 'opacity-50 pointer-events-none' : ''">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 服務名稱 -->
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-medium">服務名稱</span>
              </label>
              <input 
                type="text" 
                x-model="newSubscription.name"
                placeholder="例如：Netflix, Spotify"
                class="input input-bordered w-full focus:input-primary"
                required
              >
            </div>
            
            <!-- 原始價格 -->
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-medium">原始價格</span>
              </label>
              <input 
                type="number" 
                x-model="newSubscription.originalPrice"
                placeholder="9.99"
                min="0"
                step="0.01"
                class="input input-bordered w-full focus:input-primary"
                required
              >
            </div>
            
            <!-- 貨幣選擇 -->
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-medium">貨幣</span>
              </label>
              <select 
                x-model="newSubscription.currency"
                class="select select-bordered w-full focus:select-primary"
                required
              >
                <option value="TWD">🇹🇼 台幣 (TWD)</option>
                <option value="USD">🇺🇸 美元 (USD)</option>
                <option value="EUR">🇪🇺 歐元 (EUR)</option>
                <option value="JPY">🇯🇵 日圓 (JPY)</option>
                <option value="GBP">🇬🇧 英鎊 (GBP)</option>
                <option value="KRW">🇰🇷 韓圓 (KRW)</option>
                <option value="CNY">🇨🇳 人民幣 (CNY)</option>
              </select>
            </div>
            
            <!-- 訂閱週期 -->
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-medium">訂閱週期</span>
              </label>
              <select 
                x-model="newSubscription.cycle"
                class="select select-bordered w-full focus:select-primary"
                required
              >
                <option value="monthly">每月</option>
                <option value="quarterly">每季</option>
                <option value="yearly">每年</option>
              </select>
            </div>
            
            <!-- 服務分類 -->
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-medium">服務分類</span>
              </label>
              <select 
                x-model="newSubscription.category"
                class="select select-bordered w-full focus:select-primary"
                required
              >
                <option value="">請選擇分類</option>
                <option value="streaming">🎥 影音串流</option>
                <option value="software">💻 軟體工具</option>
                <option value="news">📰 新聞資訊</option>
                <option value="gaming">🎮 遊戲娛樂</option>
                <option value="music">🎵 音樂</option>
                <option value="education">📚 教育學習</option>
                <option value="productivity">⚙️ 生產力工具</option>
                <option value="other">📋 其他</option>
              </select>
            </div>
            
            <!-- 開始日期 -->
            <div class="form-control w-full md:col-span-2">
              <label class="label">
                <span class="label-text font-medium">開始日期</span>
              </label>
              <input 
                type="date" 
                x-model="newSubscription.startDate"
                class="input input-bordered w-full focus:input-primary"
                required
              >
            </div>
          </div>
          
          <div class="flex gap-4 pt-4">
            <button 
              type="submit"
              class="btn btn-primary flex-1"
              data-loading="addSubscription"
              :disabled="!isLoggedIn"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" x-show="!isEditing"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" x-show="isEditing"></path>
              </svg>
              <span x-text="isEditing ? '更新訂閱' : '新增訂閱'">新增訂閱</span>
            </button>
            <button 
              x-show="isEditing"
              type="button"
              @click="cancelEdit()"
              class="btn btn-outline flex-1"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 分類統計圖表 -->
    <div x-show="subscriptions.length > 0" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-6">
          <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          支出分類統計
        </h2>
        <div class="space-y-4">
          <template x-for="stat in getCategoryStats()" :key="stat.name">
            <div class="card bg-base-200/50 hover:bg-base-200 transition-all duration-300 hover:shadow-md">
              <div class="card-body p-4">
                <div class="flex justify-between items-center mb-3">
                  <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                      <div class="w-10 rounded-full" :class="stat.progressColor.replace('bg-', 'bg-') + ' text-white'">
                        <span class="text-lg" x-text="getCategoryIcon(stat.originalCategory)"></span>
                      </div>
                    </div>
                    <div>
                      <h3 class="font-semibold" x-text="stat.name"></h3>
                      <p class="text-sm opacity-70" x-text="`${stat.count} 個服務`"></p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xl font-bold" x-text="formatCurrency(stat.amount)"></div>
                    <div class="badge badge-outline" x-text="`${stat.percentage}%`"></div>
                  </div>
                </div>
                <div class="mb-2">
                  <progress 
                    class="progress w-full h-2" 
                    :class="stat.progressColor.includes('red') ? 'progress-error' : stat.progressColor.includes('blue') ? 'progress-info' : stat.progressColor.includes('green') ? 'progress-success' : stat.progressColor.includes('orange') ? 'progress-warning' : stat.progressColor.includes('purple') ? 'progress-secondary' : 'progress-primary'"
                    :value="stat.percentage" 
                    max="100"
                  ></progress>
                </div>
                <div class="text-sm opacity-70 text-right">
                  <span x-text="`平均 ${formatCurrency(stat.amount / stat.count)}`"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- 訂閱項目列表 -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-6">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <h2 class="text-2xl font-bold">我的訂閱服務</h2>
        <div class="badge badge-primary" x-text="subscriptions.length"></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="subscription in subscriptions" :key="subscription.id">
          <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 border-l-4" :class="getCategoryColor(subscription.category).replace('border-', 'border-l-')">
            <div class="card-body p-6">
              <!-- 服務名稱和分類 -->
              <div class="flex justify-between items-start mb-4">
                <h3 class="card-title text-lg" x-text="subscription.name"></h3>
                <div class="badge badge-outline badge-sm" x-text="getCategoryName(subscription.category)"></div>
              </div>
              
              <!-- 價格資訊 -->
              <div class="mb-4">
                <div class="space-y-2">
                  <!-- 原始價格 -->
                  <div x-show="subscription.currency && subscription.currency !== 'TWD'" class="text-lg text-base-content/70">
                    <span x-text="formatOriginalCurrency(subscription.originalPrice, subscription.currency)"></span>
                  </div>
                  <!-- 台幣價格 -->
                  <div class="text-3xl font-bold text-success" x-text="formatCurrency(subscription.price)">
                    NT$0
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <div class="badge badge-ghost" x-text="getCycleName(subscription.cycle)"></div>
                  <div class="text-sm">
                    月費用：<span class="font-semibold" x-text="formatCurrency(getMonthlyPrice(subscription))">NT$0</span>
                  </div>
                </div>
              </div>
              
              <!-- 日期資訊 -->
              <div class="mb-4 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="opacity-70">開始日期</span>
                  <span x-text="formatDate(subscription.startDate)"></span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="opacity-70">下次付款</span>
                  <span x-text="getNextPaymentDate(subscription)"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">到期提醒</span>
                  <div class="badge badge-sm" :class="getDaysUntilPayment(subscription) <= 3 ? 'badge-error' : getDaysUntilPayment(subscription) <= 7 ? 'badge-warning' : 'badge-info'" x-text="getExpiryWarningText(subscription)"></div>
                </div>
              </div>
              
              <!-- 操作按鈕 -->
              <div class="card-actions justify-end gap-2">
                <button 
                  @click="editSubscription(subscription.id)"
                  class="btn btn-outline btn-primary btn-sm"
                >
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  編輯
                </button>
                <button 
                  @click="deleteSubscription(subscription.id)"
                  class="btn btn-outline btn-error btn-sm"
                >
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  刪除
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
      
      <!-- 空狀態提示 -->
      <div x-show="subscriptions.length === 0" class="hero bg-base-200 rounded-3xl">
        <div class="hero-content text-center py-16">
          <div class="max-w-md">
            <div class="text-6xl mb-6">📱</div>
            <h3 class="text-2xl font-bold mb-4">還沒有訂閱服務</h3>
            <p class="mb-6 opacity-70">新增你的第一個訂閱服務開始追蹤支出吧！</p>
            <button class="btn btn-primary" @click="document.querySelector('form input').focus()">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              開始新增
            </button>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
</body>
</html>